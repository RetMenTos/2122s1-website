(()=>{"use strict";const e={refreshRate:3e3,duration:3,samplingDuration:10,samplingInterval:5,bucketSize:5,disableCountdown:5,graphOptions:{legend:{position:"none"},titleTextStyle:{color:"white"},hAxis:{format:"HH:mm:ss",textStyle:{color:"#999999"},gridlines:{color:"none"}},vAxis:{textStyle:{color:"#999999"},gridlines:{color:"none"}},chartArea:{width:"80%",height:"75%"},backgroundColor:"none"}};function t(e){e.setAttribute("hidden","hidden")}function n(e){e.removeAttribute("hidden")}function a(e){const{chartDom:t}=e;e.googleChart=new google.visualization.ColumnChart(t)}function o(e){const{chartDom:t}=e;e.googleChart=new google.visualization.AreaChart(t)}function r({chartDom:e}){e.innerHTML=""}function i(e,{googleChart:t,options:n}){const a=google.visualization.arrayToDataTable(e);t.draw(a,n)}function c(e){let t;return fetch(e).then((e=>(t=e.status,e.json()))).then((e=>{if(200!==t)throw e;return e}))}function l(e){return(t,n)=>function(e,t,n){return c(function(e,t,n){return`${e}?from=${encodeURIComponent(t)}&duration=${n}`}(`https://queue-qna.herokuapp.com${e}`,t,n))}(e,t,n)}const s=l("/errors"),u=l("/arrivals"),d=l("/departures"),g=l("/processing-times"),h=l("/lengths");function m(t,n=e.bucketSize){return t-t%n}function p(t,n,a){const{bucketSize:o}=e,r=n.unix(),i=a.unix(),c={},l=[];for(let e=m(r);e<i;e+=o)c[e]=0,l.push(e);t.forEach((e=>{c[m(e)]+=1}));const s=[["Timestamp","Count"]];return l.forEach((e=>{s.push([new Date(1e3*e),c[e]])})),s}const f=t,y=n,C=t,b=n,v={"error-rate":{options:{...e.graphOptions,title:"errors/sec",colors:["#ff0000"]},createChart:a,clearChart:r,draw:i,payloadToData:function(e,t,n){return p(e.map((({timestamp:e})=>e)),t,n)},getPayload:s},"arrival-rate":{options:{...e.graphOptions,title:"arrivals/sec",colors:["#00ff00"]},createChart:a,clearChart:r,draw:i,payloadToData:p,getPayload:u},"departure-rate":{options:{...e.graphOptions,title:"departure/sec",colors:["#0000ff"]},createChart:a,clearChart:r,draw:i,payloadToData:p,getPayload:d},"average-processing-time":{options:{...e.graphOptions,title:"average processing time/sec",colors:["#FF00FF"]},createChart:o,clearChart:r,draw:i,payloadToData:function(e,t,n){const a=t.unix(),o=n.unix(),r={};e.forEach((({received_time:e,processing_time:t})=>{r[e]||(r[e]=[]),r[e].push(t)}));const i=[["Timestamp","Average"]];for(let e=a;e<o;e++)if(r[e]){const t=r[e],n=t.reduce(((e,t)=>e+t),0)/t.length;i.push([new Date(1e3*e),n])}else i.push([new Date(1e3*e),0]);return i},getPayload:g},"queue-length":{options:{...e.graphOptions,title:"sampled queue lengths",colors:["#FFFF00"]},createChart:o,clearChart:r,draw:i,payloadToData:function(e){const t=[["Timestamp","Average"]];return e.lengths.length&&e.is_sampling?[...t,...e.lengths.map((({timestamp:e,length:t})=>[new Date(1e3*e),t]))]:[...t,[0,0]]},getPayload:h},"waiting-time-stats":{options:{colors:["#006400"]},panels:[{key:"mean",label:"Average Waiting Time"},{key:"median",label:"Median Waiting Time"},{key:"max",label:"Max Waiting Time"},{key:"min",label:"Min Waiting Time"}],createChart:function(e){const{panels:t,isDrawn:n,chartDom:a}=e;n||(t.forEach((e=>{const{label:t}=e,n=document.createElement("div");n.classList.add("panel"),a.appendChild(n);const o=document.createElement("p");o.classList.add("label"),o.innerHTML=t,n.appendChild(o);const r=document.createElement("p");r.classList.add("count"),n.appendChild(r),e.countDom=r})),e.isDrawn=!0)},clearChart:()=>{},draw:function(e,{panels:t,options:n}){t.forEach((({countDom:t,key:a})=>{(e[a]||0===e[a])&&(t.innerHTML=e[a].toFixed(1),[t.parentNode.style.backgroundColor]=n.colors)}))},payloadToData:function(e){const t=dayjs().unix(),n=e.map((({arrival:e})=>Math.max(0,t-e))).sort(((e,t)=>e-t));var a;return{mean:(a=n).length?a.reduce(((e,t)=>e+t),0)/a.length:0,median:function(e){if(!e.length)return 0;const t=Math.floor(e.length/2);return e.length%2?e[t]:(e[t-1]+e[t])/2}(n),max:n[n.length-1]||0,min:n[0]||0}},getPayload:()=>c("https://queue-qna.herokuapp.com/customers")}};function D(t){const n=v[t];if(!n.canDrawChart())return;const{getPayload:a,payloadToData:o,draw:r,loadingAnimation:i,warningIcon:c}=n,{duration:l}=e,[s,u,d]=function(e){const t=dayjs().utc(),n=t.subtract(e,"minute"),a=n.format("YYYY-MM-DDTHH:mm:ss");return[t,n,a]}(l);b(i),a(d,l).then((e=>{if(!n.canDrawChart())return;f(c);const t=o(e,u,s);r(t,n)})).catch((e=>{y(c),console.error(e)})).finally((()=>{C(i)}))}let E,w;function L(t){clearInterval(E),E=setInterval((()=>{t.forEach((e=>{D(e)}))}),e.refreshRate)}function T(e,a){const o=document.getElementById("chart-containers");e.forEach((e=>{const r=a[e],i=r.containerDom,c=i.querySelector(".minimize-icon"),l=i.querySelector(".maximize-icon"),s=r.canDrawChart;r.canDrawChart=()=>s()&&function(e){return!w||w===e}(e),c.addEventListener("click",(()=>{w="",r.clearChart(a[e]),i.classList.toggle("full-screen-chart",!1),o.classList.toggle("normal",!0),o.classList.toggle("full-screen",!1),t(c),n(l),r.createChart(a[e]),D(e)})),l.addEventListener("click",(()=>{!function(e){w=e}(e),i.classList.toggle("full-screen-chart",!0),o.classList.toggle("normal",!1),o.classList.toggle("full-screen",!0),t(l),n(c),D(e)}))}))}function k(e,t){e.addEventListener("dragover",(e=>{e.preventDefault(),e.dataTransfer.dropEffect="move"})),e.addEventListener("drop",(n=>{n.preventDefault();const a=n.dataTransfer.getData("text/plain"),o=t[a].containerDom;e.parentNode.insertBefore(o,e)}))}function x(e,t){const n=document.getElementById("chart-containers");k(document.getElementById("drop-zone"),t),e.forEach((e=>{const a=t[e].containerDom;a.setAttribute("draggable",!0),a.addEventListener("dragstart",(t=>{n.classList.add("dragging"),t.dataTransfer.setData("text/plain",e),t.dataTransfer.dropEffect="move"})),a.addEventListener("dragend",(()=>{n.classList.remove("dragging")})),k(a,t)}))}Object.keys(v).forEach((e=>{v[e].canDrawChart=()=>!0}));const I=[{label:"Stop Timer (min)",initial:e.disableCountdown,type:"number",onChange:t=>{e.disableCountdown=t}},{label:"Refresh Rate (ms)",initial:e.refreshRate,type:"number",onChange:(t,n,a)=>{e.refreshRate=t,L(n)}},{label:"Duration (min)",initial:e.duration,type:"number",onChange:t=>{e.duration=t}},{label:"Bucket Size (sec)",initial:e.bucketSize,type:"number",onChange:t=>{e.bucketSize=parseFloat(t)}},{label:"Sampling Duration (min)",initial:e.samplingDuration,type:"number",onChange:t=>{e.samplingDuration=parseFloat(t)}},{label:"Sampling Interval (sec)",initial:e.samplingInterval,type:"number",onChange:t=>{e.samplingInterval=parseFloat(t)}},{label:"Start sampling length",title:"Start",type:"button",onClick:()=>function(e,t){return fetch(`https://queue-qna.herokuapp.com/sample-length?interval=${e}&duration=${t}`,{method:"PUT"}).catch((e=>alert(e)))}(e.samplingInterval,e.samplingDuration)}];function S(e,t){const n=document.getElementById("config-container");e.forEach((e=>{I.push(function(e,t){return{label:`${e} color`,type:"color",initial:t.options.colors[0]||"black",onChange:n=>{t.options.colors=[n],D(e)}}}(e,t[e]))})),I.forEach((({label:a,type:o,...r})=>{let i;if("button"===o){const{title:e,onClick:t}=r;i=document.createElement("button"),i.innerHTML=e,i.addEventListener("click",t)}else{const{onChange:n,initial:a}=r;i=document.createElement("input"),i.setAttribute("type",o),i.value=a,i.addEventListener("focusout",(()=>{n(i.value,e,t)}))}const c=document.createElement("label");c.innerHTML=a;const l=document.createElement("div");l.classList.add("config"),l.appendChild(c),l.appendChild(i),n.appendChild(l)}));let a=!0;document.getElementById("toggle-config").addEventListener("click",(()=>{n.classList.toggle("hidden",!a),a=!a}))}let q,A=!1;function M(e,t){const n=dayjs().unix();if(n>t)A=!0;else{const a=t-n;e&&(e.innerHTML=`â³${a}`)}}function z(t){q&&clearInterval(q),A=!1;const n=dayjs().add(e.disableCountdown,"minute").unix();M(t,n),q=setInterval((()=>{M(t,n)}),1e3)}function F(e,t){!function(e,t){e.forEach((e=>{const n=t[e],a=n.canDrawChart;n.canDrawChart=()=>!A&&a}))}(e,t);const n=document.getElementById("timer");n.addEventListener("click",(()=>{z(n)})),z(n)}google.charts.setOnLoadCallback((function(){!function(e){const t=Object.keys(v);t.forEach((e=>{const t=v[e],n=document.getElementById(e);t.containerDom=n,t.chartDom=n.querySelector(".chart"),t.loadingAnimation=n.querySelector(".loading-icon"),t.warningIcon=n.querySelector(".warning-icon"),t.createChart(t),D(e)})),e.forEach((e=>{e(t,v)}))}([L,T,x,S,F])}))})();